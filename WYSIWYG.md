# WYSIWYG 重构方案（参考 milkup）

本文档描述 flyMD 的所见模式（WYSIWYG）重构蓝图，基于对 Auto-Plugin/milkup 的实现对标与本项目现状梳理，目标是在不更换编辑内核（textarea + overlay）的前提下，显著提升稳定性与可维护性，并为后续 2.0（引入 Milkdown/ProseMirror）预留演进空间。

## 背景与目标
- 现状：采用 overlay 所见方案，预览层覆盖编辑层，依赖“滚动比例同步 + 虚拟 padding + 延迟渲染 + 点状光标”来模拟所见体验。
- 痛点：
  - 长图/大块元素异步加载导致比例同步失准，滚动抖动、定位回拉；
  - 渲染、滚动、光标、上传、插件逻辑耦合在 ，维护与扩展成本高；
  - 块级渲染（Mermaid/KaTeX/代码）与输入规则（自动列表/引用/标题）欠缺模块化。
- 目标：
  - 引入“源位锚点”映射，替换单纯比例同步为“锚点优先 + 比例兜底”；
  - 渲染管线分层（轻渲染/重渲染）、视口内优先、异步重排自校准；
  - 模块化滚动与光标、块渲染器与输入规则；
  - 风险可控、渐进迁移，不改用户心智。

## 参考项目（milkup）要点
- 内核：Milkdown（ProseMirror）+ Crepe UI，真正所见编辑；Markdown 作为导入/导出。
- 组件与插件：
  - 编辑器：
  - 粘贴上传：
  - Mermaid 节点：
  - HTML 混排节点与规则：
  - Crepe 配置增强（中文短语、BlockEdit 搜索 abbr）： + 
- 关键思路：
  - 块/行都是“结构化节点”，渲染/滚动/选择天然稳健；
  - 通过 InputRule/remark/NodeView 完成输入自动结构化、块渲染与交互；
  - 滚动恢复与大纲直接由视图/文档模型驱动。

## 本项目现状概览
- Overlay 所见：（.container.wysiwyg）、（逻辑集中）。
- 滚动同步： 比例法； 容器层 wheel 接管，预览优先兜底； 虚拟 padding 动态补高。
- 渲染策略： renderPreview（插入点光标/零宽字符，围栏/行内公式闭合延迟渲染，Mermaid 缓存）。
- 现有修复：大图滚动、Mermaid/KaTeX 闪烁与未闭合围栏的回避，详见 。

## 差距与问题
- 滚动/定位：比例法对“异步重排/超长块”不稳；缺少“源位锚点”。
- 渲染耦合：渲染/滚动/光标/上传/插件集中于单文件；块渲染与调度未分层。
- 输入规则：仅有围栏/行内数学的局部处理，缺少统一规则层（列表/引用/标题）。

## 重构路线 A（低风险增强，保留 overlay）
目标：以“锚点映射 + 管线化 + 模块化”为核心，最小代价提升体验。

### 1) 目录与模块
- ：所见模式状态/策略（enter 再渲染、围栏/行内 $ 延迟）。
- ：rAF + idle 调度；输入跑“轻渲染”，空闲/停顿跑“重渲染”。
- ：统一 ensureRenderer；注入 markdown-it 插件（锚点）；导出 。
- ：块渲染器，含缓存与 shouldRender。
- ：构建 AnchorMap（pos/line → DOM top），。
- ： 预览/编辑优先切换（阈值+去抖）、。
- ：measureCharWidth/visualColumn/moveByLines/updateDot/ensureDotInView。
- ：输入规则（列表/引用/标题/围栏/行内 $），集中维护。
- ：粘贴上传适配层（复用现有 S3/R2 上传能力）。

### 2) 关键替换点（桥接，行为不变）
- 滚动同步： 用  替换比例法（失败兜底比例）。
- 滚轮处理： 调用 （保留虚拟 padding 与反推光标）。
- 虚拟 padding： 迁移为 ，在图片/公式/mermaid onload 调用。
- 渲染分层： 拆  → ； 先 light，再 idle heavy；视口内优先。
- 输入规则：将  抽到 rules 层，并新增常见规则（行首  列表、 引用、 标题），默认可配。

### 3) 锚点构建与同步（示例）
- markdown-it 锚点插件为块 token 注入 ，构建 AnchorMap；滚动映射时优先按“最近锚点 + 行高估算”，比例法兜底。

### 4) 滚轮优先与去抖（示例）
- 保留现有  的优化逻辑，后续抽离到  并加入阈值与去抖。

### 5) 行为增强
- 视口内优先（IntersectionObserver）：heavy 只渲染可见块，滚动进入再补渲染。
- 大纲生成：轻渲染阶段收集 headings，提供 Outline（与 milkup 的  思路一致）。
- 图片/图表 onload：触发 recalibrate（重算 Anchors）+ 局部重渲染（避免整屏闪烁）。

## 实施计划（3 周）
- 第 1 周：
  - 新增  框架；将现有  外包到 ，行为等价；
  - 上“锚点映射 + 同步”并替换 ； 下沉重用；
  - 保留比例兜底与虚拟 padding；回归“长图/大图/未闭合围栏”。
- 第 2 周：
  - 模块化块渲染器（mermaid/katex/code），启用轻/重渲染分层与视口内优先；
  - 输入规则层初版：列表/引用/标题开关化。
- 第 3 周：
  - HTML 插件化（安全 through DOMPurify + 规则）；
  - 压测与指标采集（渲染耗时、滚动跳变次数），修复边界问题。

## 验收与指标
- 功能：
  - 大图/长表格/多 mermaid/公式输入下滚动无卡死；未闭合围栏/行内 $ 不闪烁；
  - 图片/图表 onload 只“温和推进”，不回拉，不需多次滚轮。
- 体验：
  - 快速输入/退格不卡顿，渲染分层可观察到“先文本、后重块”的稳定节奏；
  - Outline 与滚动位置保持一致。
- 指标：
  - 重排次数与渲染耗时下降；滚动同步命中“锚点法”的比例显著高于“比例兜底”。

## 风险与回滚
- 风险：锚点构建正确性、异步重排导致锚点失效、输入规则误触发。
- 缓解：
  - 失败兜底比例法；
  - onload → recalibrate + 局部重渲染；
  - 规则全开关、可撤销。
- 回滚：保留旧  的 feature flag，问题时一键回退。

## 2.0 展望（可选路线 B）
- 引入 Milkdown/ProseMirror 构建真正所见编辑；
- Markdown ↔ Model 导入导出；
- Node/Mark/Transaction + Command 体系；
- 分阶段“岛屿化”替换（先表格/任务列表等交互块）。

## 附：关键参考路径（milkup）
- 编辑器：
- 粘贴上传：
- Mermaid：
- HTML 节点与规则：
- Crepe 配置增强：
- Crepe 补丁：

## 当前进度与问题 [记录]

- 已执行的重构
  - 彻底删除旧 Overlay 所见模式（代码、事件、样式全部移除），仅保留全新所见 V2 路线。
  - 引入所见 V2（基于 Milkdown Editor API，而非 crepe），避免样式导出路径导致的 Vite 构建错误。
  - 切换所见模式的加载过渡：加载中保留 textarea，可编辑；初始化完成后再切换到 V2 视图。
  - 打开文件后的刷新逻辑：若 V2 启用，则刷新 V2 内容，不再切到旧预览。
  - UI：淡蓝背景（区分普通模式）、右下角“所见模式 · Ctrl+Shift+E 退出”的提示。
  - 样式：补齐 ProseMirror 的基础样式（不依赖外部包样式），隐藏任何 role=toolbar 的工具条。

- 遇到的问题及修复
  - 环境差异：@milkdown/crepe/style.css 在某些环境下无法通过 Vite 的 exports 解析，导致 Missing specifier 报错（已通过移除 crepe 依赖、直接使用 Editor API 规避）。
  - 编辑/滚动无响应：初期是 overlay 残留事件/层级遮挡；后续由加载过渡策略与强制 focus 修复。
  - 打开库中文档为空白：原逻辑在打开文件后强制切到预览；已改为在 V2 下刷新 V2 内容，不再切预览。
  - 连续回车"上跳"体验：V2 内核的默认滚动行为仍需做"回车稳定策略"（记忆前/后 scrollTop，仅必要时滚动）。
  - **工具条显示混乱 + 无法输入内容**（2025-11-03 修复，二次迭代）：
    - 问题1：未保存文档激活所见模式时，显示富文本编辑器的工具条、按钮和菜单（B/I/删除线/列表等），界面混乱。
    - 问题2：修复后工具条隐藏了，但编辑器无法输入内容。
    - 根因：
      - @milkdown/plugin-automd（即 block 插件）会自动创建 block-handle 和 actions 菜单 UI。
      - 移除 automd 插件会导致失去重要的编辑功能。
      - 过于宽泛的 CSS 选择器（如 `[class*="block-"]`）会隐藏内容块，导致无法编辑。
    - 最终修复：
      - **保留 automd 插件**（提供编辑功能）。
      - 使用**精确的 CSS 选择器**只隐藏 UI 组件：`[data-block-handle]`、`[data-slash-menu]`、`.slash-dropdown`、`.block-menu` 等。
      - 移除过于宽泛的通配符选择器，避免误伤内容块。
  - **已保存文档选择所见模式时文档消失**（2025-11-03 修复）：
    - 问题：在已保存文档中切换到所见模式后，文档内容变为空白。
    - 根因：enableWysiwygV2 被多次调用时逻辑混乱；清空 root.textContent 后若提前返回会导致空白。
    - 修复：简化逻辑，总是重新创建编辑器；移除不必要的空内容检查；添加调试日志跟踪内容长度。
  - **V2 启动异常后仍处于 loading 导致空白/不可编辑**（2025-11-03 补充修复）：
    - 问题：V2 初始化抛错时 `.container` 遗留 `wysiwyg-v2-loading`，`#md-wysiwyg-root` 被隐藏。
    - 修复：在 catch 分支清理 `wysiwyg-v2-loading` 与 `wysiwyg-v2` 类，确保回退路径可见。
  - **旧 overlay 类误伤容器导致“所见后整页消失”**（2025-11-03 补充修复）：
    - 问题：`.container.wysiwyg { display: none; }` 一旦被历史路径加上 `.wysiwyg`，容器整体被隐藏。
    - 修复：保留占位但不再隐藏：`.container.wysiwyg { /* legacy: no-op */ }`。
  - **所见内容未回写导致“看似空白”**（2025-11-03 补充修复）：
    - 方案：启用 `@milkdown/plugin-listener`，在 `markdownUpdated` 事件中回调外层 `onChange`，稳定回写。
  - **粘贴/拖拽上传集成**（2025-11-03 新增）：
    - 接入 `@milkdown/plugin-upload`，通过 `window.flymdGetUploaderConfig()` 拉取配置，优先 S3/R2 上传，失败兜底 base64。

- 尚未完成（下一步）
  1) 回车稳定策略：在 V2 内监听 Enter，计算前/后 scrollTop 与可见性，仅必要时滚动到视图；对列表/标题/代码块等特殊块做微调。
  2) 所见→源码回写：接入 @milkdown/plugin-listener 实现稳定回写（避免初次回写为空/抖动）。
  3) 图表与安全 HTML 节点（不暴露第三方信息）：
     - 图表节点：attrs.value 存源码、toDOM 渲染 SVG（缓存+视口内优先），与当前 mermaid 懒加载兼容。
     - HTML 节点：通过 dompurify 白名单过滤，支持安全的 inline html 显示。
  4) 所见 V2 懒加载：用动态 import 在切换时加载，首屏零增量；并在加载前显示过渡提示。
  5) 回归测试：已保存/未保存文档、打开/切换所见、粘贴上传、长文档滚动、连续回车、特殊块输入等。

- 风险/注意事项
  - 由于完全删除 overlay 路线，后续仅在 V2 内修正编辑体验；若需紧急回退，需要增加一个开关（当前不建议回退，以免又回到旧问题）。
  - 如仍出现“打开库中某些文档为空白”，请提供该文件路径与编码信息（UTF-8/UTF-16）及 Console 报错，将进一步处理编码/解析兼容。
